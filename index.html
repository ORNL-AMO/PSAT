<!DOCTYPE html>
<html>
  <head>
  <title>Pumping System Assessment Tool</title>
  <link rel="stylesheet" href="font-awesome-4.6.3/css/font-awesome.min.css">
    <style>
      html {
        font-family: sans-serif;
        font-size: 14pt;
      }
      body {
        padding:2.5% 5%;
        background-color: ghostwhite;
      }
      .hover:hover, button:hover {
        cursor: pointer;
        
      }
      h1,th {
        color: green;
      }
      em, dialog label {
        font-size: .75rem;
        font-style: italic;
      } 
      button {
        color: dodgerblue;
      }
      input:not([type=radio]) {
        padding: .5em;
        border: solid 1px #fff;
        box-shadow: inset 1px 1px 2px 0 #707070;
      }
      #back {
        position: absolute;
        top: 1rem;
        left: 1rem;
        display: none;
      }
    </style>
  </head>
  <body> 
    <dialog id=unit_sgl>
      Enter value in <span></span><br>
      <input><br>
      <button onclick='cvtUnitSgl($(this).parent())'>CONVERT</button>
      <button onclick='this.parentElement.close()'>CANCEL</button>       
    </dialog> 
    <dialog id='unit_flow'>
      Choose units<br>
      <label>
        <input name=units value=.0630901966667 type="radio" checked> gpm
      </label><br>
      <label>
        <input name=units value=43.8126364 type="radio"> MGD
      </label><br>
      <label>
        <input name=units value=0.277778 type="radio"> m^3/hr
      </label>
      <div style='margin:.5rem 0;'>
        Enter value<br>
        <input>
      </div>
      <button onclick='cvtUnitFlow($(this).parent())'>CONVERT</button> 
      <button onclick='this.parentElement.close()'>CANCEL</button>
    </dialog>
    <button id=back onclick='back()'><i class="fa fa-long-arrow-left fa-lg"></i></button>
    <div id=container></div>
    <script>
      function dom(e) {
        return $(e)[0];
      }
      function rnd(v) {
        return Math.round(v*10000)/10000;
      }
      CVT_FLOW = {MGD:694.4422834,'m^3/hr':4.402867544,'L/s':15.85032316, 
        'm^3/s':15850.32316, 'ft^3/s':448.8311693};

      function cvt(v,i,nu,m) {
        if (m[Units[i]]) {
          v *= m[Units[i]];
        }
        if (m[nu]) {
          v /= m[nu];
        }
        return v;
      }
      function cvtUnit(dlg,m) {        
        dlg.data('src').prev().val(rnd(dlg.find('input:not([type=radio])').val()*m));        
        dlg[0].close();
      }      
      function cvtUnitFlow(dlg) {
        cvtUnit(dlg,dlg.find(':checked').val());
      }
      function showUnit(e,sel) {
        const dlg = $(sel);
        dlg.find('input:not([type=radio])').val('');
        dlg[0].showModal();
        dlg.data('src',$(e)); 
      }
      function showUnitSgl(e,txt,m) {
        const dlg = $('#unit_sgl');
        dlg.find('span').html(txt);
        dlg.data('m',m);
        showUnit(e,dlg);
      } 
      function cvtUnitSgl(dlg) {      
        cvtUnit(dlg,dlg.data('m'));
      }
      function showUnit_m(e) {
        showUnitSgl(e,'feet',.3048);
      }
      function parIdx(e,a=0) {
        return $(e).parent().index()+a;
      }
      function saveCond() {
        saveProp('conditions',Cond);
      }  
      function loadProp(nm) {
        return JSON.parse(LS.getItem(nm));
      }
      function saveProp(nm,v) {
        LS.setItem(nm,JSON.stringify(v));
      }
      IMP = ['gpm','hp','ft','psig'];      
      function restoreDefaults() {
        saveProp('defaultCondition', {
          pump_style: 5,
          pump_rpm: 1780,
          drive: 0,
          viscosity: 1,
          specific_gravity: 1,
          stages: 1,
          speed: true,
          line: 1,
          power_rating: 30,
          motor_rpm: 1780,
          efficiency: 0,
          motor_voltage: 460,
          amps: 225.4,
          margin: 0,
          fraction: 1,
          cost: .05,
          flow: 2000,
          head: 277,
          load_method: 0,
          est_power: 150,
          field_voltage: 460,

          grid: false       
        });        
        saveProp('units',IMP);//TODO existing cond? cvt? eek!
      }
      function load(nm,bkHide,fn) {
        back = main;
        $('#container').load(nm+'.html',function () {
          if (bkHide) {
            $('#back').hide();
          } else {
            $('#back').show();
          }
          if (fn) fn();
        });
      }
      function main() {
        load('conditions',true);
      }      
      $ = require('jquery');
      Bridge = require('./build/Release/bridge');
      LS = localStorage;
      Cond = loadProp('conditions') || []
      if (loadProp('defaultCondition')===null) {
        restoreDefaults();
      }
      $(document).ready(function() {
        main();
      });
    </script>
  </body>
</html>
