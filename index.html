<!DOCTYPE html>
<html>
  <head>
  <title>Pumping System Assessment Tool</title>
  <link rel="stylesheet" href="font-awesome-4.6.3/css/font-awesome.min.css">
    <style>
      em, dialog label {
        font-size: .75rem;
        font-style: italic;
      }
      label:hover {
        cursor: pointer;
      }
      label [type=radio] {
        vertical-align: middle;
        margin-top: 0;        
      }
      label {
        display: block;
      }

      [type=checkbox]:hover {
        cursor: pointer;
      }
      input:not([type=radio]) {
        padding: .5em;
        border: solid 1px #fff;
        box-shadow: inset 1px 1px 2px 0 #5E6A71;
      }

      .prime {
        color: white;
        background-color: dodgerblue;
      }     
      button {
        color: dodgerblue;
        background-color: white;
        border: 1px solid #C3C8C8;
        border-radius: 4px;
        padding: 3px 6px;
      }
      button:hover {
        border-color: dodgerblue;
        cursor: pointer;
      }

      h1 {
        color: #5d9300;
      }

      th,.th {
        color: #5d9300;
        font-weight: bold;
        text-align: center;
        white-space: nowrap;
      }
      td {
        white-space: nowrap;
      }
      td > * {
        vertical-align: middle;
      }

      #container {
        padding:0 5%;
      }
      #banner {
        padding:10px 5%;   
        margin-bottom: 10px;   
        background-color: #5d9300;
        box-shadow: 0 3px 3px rgba(0,0,0,.5);

        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size:20pt;
        font-weight:bold;
      }
      body {
        margin:0;
      }
      html {
        font-family: sans-serif;
        font-size: 14pt;
      }
    </style>
  </head>
  <body> 
    <div id="banner">
      <img src="logo_eere.png" style='padding-right:1rem'><span style='padding-left:1rem'>Pumping System Assessment Tool</span>
    </div>
    <button id=back onclick='back()'><i class="fa fa-long-arrow-left fa-lg"></i></button>
    
    <div id=container></div>
    <script>
      function rnd(v,p=4) {
        const m=Math.pow(10,p);
        return $.isNumeric(v) ? Math.round(v*m)/m : v;
      }
      function em(t) {
        return ` <em>(${t})</em>`;
      }
      function checked(e=pg()) {
        return $(e).find(':checked');
      }
      function chk(e,v) {
        $(e).prop('checked',v);
      }
      function nmGet(e) {
        return $(e).attr('name');
      }
      function nmAll(e) {
        return nm('',e);
      }
      function nm(nm,e=document) {
        return $(e).find(`[name=${nm}]`.replace('=]',']'));              
      }
      function parIdx(e,a=0) {
        return $(e).parent().index()+a;
      }
      function pparIdx(e) {
        return parIdx($(e).parent());
      }
      function dom(e) {
        return $(e)[0];
      }
      function pg(s='') {
        return $('#container '+s);
      }

      function setData(d,e) {
        let v;
        nmAll(e).each(function(i,el) {
          switch (el.type) {
            case 'checkbox':
              v = el.checked;
              break;
            case 'select-one':
              v = $(el).children(':selected').index();
              break;
            default:
              v = $(el).val();
          }
          d[nmGet(el)] = v;
        });
        return d; 
      }     
      function setCtls(d,el) {
        nmAll(el).each((j,e)=>{
          const ctl = $(e), v = d[nmGet(ctl)];
          if (v===undefined) return;
          switch (e.type) {
            case 'checkbox':
              e.checked = v;
              break;
            case 'select-one':
              ctl.find('option')[v].selected = true;
              break;
            default:
              ctl.val(rnd(v));
          }
          if (ctl.is('[data-init-chg]')) {
            ctl.trigger('change');
          }
        });
      }

      FLOW = {MGD:694.4422834,'m^3/hr':4.402867544,'L/s':15.85032316, 
        'm^3/s':15850.32316, 'ft^3/s':448.8311693, _num:0};
      POWER = {kW:1.341022218, _num:1}
      DIST = {m:3.280839895, _num:2};
      PRESSURE = {kPa:0.145037738007,m:1.42197020632,ft:0.433527501928,_num=3};

      function unit(m) {
        return Units[m._num];
      }
      function cvtObj(d,nms,m,nu,old) {
        $.makeArray(nms).forEach((nm)=>{
          d[nm] = cvt(d[nm],m,nu,old);
        });
      }
      function cvt(v,m,nu,old=units(m)) {
        if (m[old] != m[nu]) {
          if ($.isNumeric(v)) {
            if (m[old]) {
              v *= m[old];
            }
            if (m[nu]) {
              v /= m[nu];
            }
          }
        }
        return v;
      }
      
      function main() {
        Nav = [];
        go('conditions');
      }
      function back() {
          Nav.pop();
          loadPg();
      }
     function loadPg() {
        pg().load(Nav[Nav.length-1]+'.html',function () {
          if (Nav.length>1 ) {
            $('#back').show();            
          } else {
            $('#back').hide();
          }
        });       
     }
      function go(nm) {
        Nav.push(nm);
        loadPg();
      }

      function saveHd(d=HeadTool) {
        saveProp('headTool',d);
      }
      function saveConds() {
        saveProp('conditions',Conds);
      }  
      function loadProp(nm) {
        return JSON.parse(LS.getItem(nm));
      }
      function saveProp(nm,v) {
        LS.setItem(nm,JSON.stringify(v));
      }

      IMP = ['gpm','hp','ft','psig'];      
      function loadData(reset) {
        if (reset) {
          saveProp('defCond', {
            pump_style: 5,
            pump_rpm: 1780,
            drive: 0,
            viscosity: 1,
            specific_gravity: 1,
            stages: 1,
            speed: false,
            line: 1,
            motor_rated_power: 30,
            motor_rated_speed: 1780,
            efficiency_class: 0,
            efficiency:0,
            motor_rated_voltage: 460,
            motor_rated_flc: 225.4,
            margin: 0,
            fraction: 1,
            cost: .05,
            flow: 2000,
            head: 277,
            //load_method: 0,
            motor_field_power: 150,
            motor_field_current: '',
            motor_field_voltage: 460,

            grid: false       
          });        
          saveProp('units',IMP);
          saveProp('conditions',[]);
          saveHd({Ds:14,Dd:10,Ps:5,Pd:124,Ks:1,Kd:1});          
        }
        Conds = loadProp('conditions');
        Units = loadProp('units');
        HeadTool = loadProp('headTool');
        return (DefCond = loadProp('defCond'));
      }
      Dlg=require('electron').remote.dialog;
      Bridge = require('./build/Release/bridge');
      LS = localStorage;
      $ = require('jquery');

      if (!loadData()) {
        loadData(true);
      }
      $(document).ready(function() {
        main();
      });
    </script>
  </body>
</html>
