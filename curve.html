
<style scoped>
	canvas {
		background-color: black;
	}
	#plot {
		display: none;
	}
	th {
		text-align: left;
	}
	td>* {
    	display: block;
	}
	button {
		margin: .5rem 0;
		display: none;
	}
	#plot td:first-child {
		color: #5d9300;
	}
	#plot td:last-child {
		text-align: right;
	}
}
</style>
<div>
	<h1>System Head Curve</h1>
	<div style='margin-bottom:1rem;xfont-style:italic'>
		Choose two points for <strong>head</strong> and <strong>flow</strong>:
	</div>
	<table id=points>
		<tr>
			<th></th>			
			<th>Flow</th>
			<th>Head</th>
			<th>Condition</th>
		</tr>
		<tr>
			<td><input type=checkbox></td>			
			<td><input></td>
			<td><input></td>			
		</tr>
	</table>
	<button class='prime' onclick='plot()'>PLOT</button><br>
	<div id=plot>
		<table>
			<tr>
				<td>Static Head:</td><td id=Hs></td>		
			</tr>
			<tr>
				<td>Loss coefficient K:</td><td id=K></td>
			</tr>
		</table>
		<canvas width="700" height="500"></canvas>
	</div>
</div>

<script>//# sourceURL=*curve
	function showHdBtn(show) {
		pg('button')[show]();
	}
	function tblTxt(r,c) {
		const td = pg(`#points tr:eq(${r}) td:eq(${c})`);
		if (r!=pg('#points tr').length-1) {
			return td.text();
		}
		return td.find('input').val();
	}
	function steps(v1,v2) {
		const 	max = Math.max(v2,v2),
				m10 = Math.pow(10, Math.floor(Math.log10(max / 15))),
				step = Math.round(max / 15 / m10) * m10;
		return [max, step, Math.ceil(max / step)];
	}
	function plot() {
		const 	r1 = pparIdx(checked().first()),
				f1 = tblTxt(r1,1),
				h1 = tblTxt(r1,2),
				r2 = pparIdx(checked().last()),			
				f2 = tblTxt(r2,1),
				h2 = tblTxt(r2,2),  
				[xMax, xStep, xCnt] = steps(f1,f2),
				//xMax = Math.max(f1,f2),
				//x10 = Math.pow(10,Math.floor(Math.log10(xMax/15))),
				// xSteps = steps(f1,f2),
				// xStep = xSteps[0],
				// xCnt = xSteps[1],
				y = Math.max(h1,h2),
				yMax = Math.max(h1,h2),
				y10 = Math.pow(10,Math.floor(Math.log10(yMax/15))),
				yStep = Math.round(yMax / 15 / y10) * y10,
				yCnt = Math.ceil (yMax / yStep),
				hS = h1-(Math.pow(f1,1.9) * (h2-h1) / (Math.pow(f2,1.9) - Math.pow(f1,1.9))),
				k = (h2-h1)/(Math.pow(f2,1.9)-Math.pow(f1,1.9));
		// const [xMax, xStep, xCnt] = steps(f1,f2);

		$('#Hs').text(rnd(hS));
		$('#K').text(rnd(k,6));
		showHdBtn('hide');
		$('#plot').show();

		const cnv = dom(Cnv), ctx = cnv.getContext('2d');					
		ctx.strokeStyle = "green";
		ctx.fillStyle = "white";
		ctx.textAlign = 'center';
		ctx.textBaseline = 'middle';
		ctx.font = '12px san serif';
		PAD = 50;
		function xPos(x) {
			return x*(cnv.width-PAD*2)/(xStep*xCnt)+PAD;
		}
		function yPos(y) {
			return (yStep*yCnt-y)*(cnv.height-PAD*2)/(yStep*yCnt)+PAD;
		}

		ctx.beginPath();
		for (let i=0; i<=xCnt; i++) {
			const x = i*xStep;
			const xp = xPos(x);
			ctx.moveTo(xp,PAD);
			ctx.lineTo(xp,cnv.height-PAD);	
			ctx.fillText(x,xp,cnv.height-.75*PAD);	
		}
		for (let j=0; j<=yCnt; j++) {
			const y = j*yStep;
			const yp = yPos(y);
			ctx.moveTo(PAD,yp);
			ctx.lineTo(cnv.width-PAD,yp);	
			ctx.fillText(y,.75*PAD,yp);	
		}
		ctx.stroke();
		ctx.save();

		ctx.fillStyle = 'yellow';
		ctx.font = '14px san serif';
		ctx.fillText('FLOW RATE',cnv.width/2,cnv.height-.33*PAD);
		
		ctx.translate(.33*PAD,cnv.height/2);
		ctx.rotate(-Math.PI/2);
		ctx.fillText('HEAD',0,0);	
		
		ctx.restore();

		ctx.lineWidth = 2;
		ctx.strokeStyle = "yellow";	
		ctx.beginPath();
		
		for (let x=0; x<=xMax; x+=xStep/10) {			
			ctx.lineTo(xPos(x), yPos(hS+k*Math.pow(x,1.9)));		
		}
		ctx.stroke();
	}

	$('th:gt(1)',Grid).each((i,e)=>{
		const 	idx = $(e).index(),
      			col = $(`td:nth-child(${idx+1})`,Grid);
	  pg('#points tr').last().before(`<tr>
	  						<td><input type=checkbox></td>
							<td>${nm('flow',col).val()}</td>
							<td>${nm('head',col).val()}</td>
							<td>${Cond[idx-2].name}</td>							
						</tr>`);
	});
	Cnv = $('canvas');
	pg('input').change(function (){
		$('#plot').hide();
		dom('canvas').width+=0;
		let show='hide';
		switch (checked().length) {			
			case 2:
				const inp = checked().last().parent().parent().find('input');
				if (inp.length==1 || ($.isNumeric(inp.eq(1).val()) && $.isNumeric(inp.eq(2).val()))) {
					show = 'show';
				}
				break;
			case 3:				
				chk(pg(':checkbox'),false);
				chk(this,true);
		}
		showHdBtn(show);
	});
	function showUnit(txt,n) {
		pg(`th:contains(${txt})`).append(em(Units[n]));
	}
	showUnit('Flow',0);
	showUnit('Head',2);
</script>

