
<style scoped=scoped>       
  #results,#results~tr {
    display:none;
  }
  #results td:not(:first-child) span,#results~tr span {
    width:50%;
  }
  td>div>em {
    color: #5d9300;
  }
  td>div {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }  
  td select {
    width:100%;
    padding-left: 5px;
    padding-right: 5px;
    display: block;
  }
  td input:not([type=checkbox]) {
    width:7rem;
  }
  td:nth-child(2),th:nth-child(2) {
    display: none;
  }
  tr:nth-child(even) {
    background-color: #C3C8C8;
  }
</style>
<table id=grid>  
  <tr>      
    <th style='vertical-align: bottom' onclick=backload('mock')>Pump</th>
      <th>
        <button onclick='rm(this)'><i class="fa fa-times"/></button>
        <button onclick='edit(this)'><i class="fa fa-pencil-square-o"></i></button>
        <button class=ioBtn onclick='showIO(this);'><i class="fa fa-trash-o"></i></button><br>
        <span></span>
      </th>      
  </tr>
  <tr>
    <td><span>Style</span></td>
    <td>
      <select name='pump_style'>
        <option>End suction slurry</option>
        <option>End suction sewage</option>
        <option>End suction stock</option>
        <option>API double suction</option>
        <option>Multistage boiler feed</option>
        <option>End suction ANSI/API</option>
        <option>Axial flow</option>
        <option>Double suction</option>
        <option>Vertical turbine</option>
        <option>Large end suction</option>
        <option>Specified optimal eff</option>
      </select>
    </td>
  </tr>  
  <tr>
    <td><div>Speed <em>(rpm)</em></div></td><td><input name='pump_rated_speed'></td>
  </tr>
  <tr>
    <td>Drive</td>
    <td> 
      <select name='drive'>
        <option>Direct drive</option>
        <option>Belt drive</option>
      </select>
    </td>
  </tr>
  <tr>
    <td><div>Kinematic Viscosity <em>(cS)</em></div></td>
    <td><input name='viscosity'></td>
  </tr>
  <tr>
    <td>Specific Gravity</td>
    <td><input name='specific_gravity'></td>
  </tr>
  <tr>
    <td>Number Stages</td>
    <td><input name='stages' type=number></td>
  </tr>
  <tr>
    <td>Fixed Specific Speed?</td>
    <td><input name='speed' type=checkbox></td>
  </tr>
  <tr>
    <td class='th'>Motor</td><td/>
  </tr>
    <td><div>Line freq <em>(Hz)</em></div></td>
    <td> 
      <select name='line'>
        <option>50</option>
        <option>60</option>
      </select>
    </td>
  </tr>      
  <tr>
    <td><div>Power Rating</div></td>
    <td>
      <input name='motor_rated_power'>
    </td>
  </tr>
  <tr>
    <td><div>Speed <em>(rpm)</em></div></td>
    <td><input name='motor_rated_speed'></td>
  </tr>
  <tr>
    <td>Efficiency Class</td>
    <td> 
      <select name='efficiency_class' onchange='effChg(this)' data-init-chg>
        <option>Standard</option>
        <option>Energy</option>
        <option>Average</option>
        <option>Custom</option>
      </select>
      <input name='efficiency'></input>
    </td>
  </tr>    
  <tr>
    <td><div>Voltage<em>(V)</em></div></td>
    <td><input name='motor_rated_voltage'></td>
  </tr>
  <tr>
    <td><div>Full-load Current<em>(A)</em></div></td>
    <td><input name='motor_rated_flc'> <button onclick='estFLA(this)'>EST</button></td>
  </tr>
  <tr>
    <td><div>Size margin <em>(%)</em></div></td>
    <td><input name='margin'></td>
  </tr>
  <tr>
    <td class='th'>Cost</td><td/>
  </tr>
  <tr>
    <td>Operating Fraction</td>
    <td><input name='fraction'></td>
  </tr>
 <tr>
    <td><div>Energy Cost<em>($/kwhr)</em></td>
    <td><input name='cost'></td>
  </tr>
  <tr>
    <td class='th'>Field</td><td/>
  </tr>        
  <tr>
    <td><div>Flow Rate</td>
    <td><input name='flow'></td>
  </tr>
  <tr>
    <td><div>Head</div></td>
    <td>
      <input name='head'>
      <button onclick='gotoHead(this)'><i class="fa fa-wrench"/></button>
    </td>
  </tr>       
  <!--<tr>
    <td>Load estimate method</td>
    <td> 
      <select name='load_method'>
        <option>Power</option>
        <option>Current</option>
      </select>
    </td>
  </tr>-->
  <tr>
    <td><div>Motor Power</div></td>
    <td><input name='motor_field_power' onchange="clrFld('motor_field_current',this)"></td>
  </tr>
  <tr>
    <td><div>Motor Current<em>(A)</em></div></td>
    <td><input name='motor_field_current' onchange="clrFld('motor_field_power',this)"></td>
  </tr>
  <tr>
    <td><div>Motor Voltage<em>(V)</em></div></td>
    <td><input name='motor_field_voltage'></td>
  </tr>
  <tr id=results>
    <td class='th'>
      <div style='justify-content:center'>        
        Results
        <button style='margin-left:.5rem' onclick='backload("curve")'>
          <i class="fa fa-line-chart"/>
        </button>
      </div>
    </td>
    <td><div style='color:#5d9300;'><span>Actual</span><span>Optimal</span></div></td>
  </tr>
  <tr>
    <td><div>Pump Efficiency <em>(%)</em></div></td><td></td>
  </tr>
  <tr>
    <td><div>Motor Rated Power</div></td><td></td>
  </tr>
  <tr>
    <td><div>Motor Shaft Power</div></td><td></td>
  </tr>
  <tr>
    <td><div>Pump Shaft Power</div></td><td></td>
  </tr>
  <tr>
    <td><div>Motor Efficiency <em>(%)</em></div></td><td></td>
  </tr>
  <tr>
    <td><div>Motor Power Factor <em>(%)</em></div></td><td></td>
  </tr>
  <tr>
    <td><div>Motor Current <em>(amps)</em></div></td><td></td>
  </tr>
  <tr>
    <td><div>Motor Power</div></td><td></td>
  </tr>
  <tr>
    <td><div>Annual energy <em>(MWh)</em></div></td><td></td>
  </tr>
  <tr>
    <td>Annual cost</td><td></td>
  </tr>
  <tr class=th>
    <td>Summary</td><td></td>
  </tr>
  <tr class=sum>
    <td>Savings potential</td>
    <td></td>
  </tr>
  <tr class=sum>
    <td>Optimization rating</td>
    <td></td>
  </tr>
</table>
<p>
  <button onclick="results(true)">RESULTS</button>
</p>
<dialog id='io'>
  <label>
    <input name=saveopt type="radio"> Reset to default
  </label>  
  <label>
    <input name=saveopt type="radio"> Set new default
  </label>
  <button class=prime onclick='io($(this.parentElement))'>ACCEPT</button> 
  <button onclick='this.parentElement.close()'>CANCEL</button>
</dialog>

<script>//# sourceURL=*grid
  function clrFld(n,e) {
    nm(n,col(e)).val('');
  }  
  function effChg(e) {
    if ($(e).val()=='Custom') {
      $(e).next().show();      
    } else {
      $(e).next().hide();
    }
  }

  function showIO(e) {
    const dlg = $('#io');
    chk(dlg.find('input').first(),true);
    dom(dlg).showModal();
    dlg.data('src',$(e));
  }
  function ioBtn(e) {
    return $('.ioBtn').eq(parIdx(e,-1));
  }
  function col(e) {
    return $(`td:nth-child(${parIdx(e,1)})`);
  }
  function saveCol(e) {
      setData(colCond(e),col(e));          
      saveCond();
  }
  function io(dlg) {    
    let e = dlg.data('src');
    if(parIdx(checked(dlg))==0) {
      setCtls(DefCond,col(e));
      saveCol(e);
      showHdResults()
    } else {
      setData(DefCond,col(e));
      saveProp('defCond',DefCond);
    }
    dom(dlg).close(); 
  }

  function colCond(e) {
    return Cond[$(e).parent().data('idx')];
  }  
  function rm(e) {
    colCond(e).grid = false;
    col(e).remove();
    $(e).parent().remove();
  }
  
  function vdTol(n,col,v,tol) {
    nm(n,col).css('background-color',
      Math.abs(nm(n,col).val()-v)>tol*v ? '#FECB00' : '');
  }
  function fla(a) {    
    return Bridge.estFLA(a.motor_rated_power, a.motor_rated_speed,
          a.motor_rated_voltage, a.efficiency_class,a.efficiency);
  }
  function estFLA(e) {
    nm('motor_rated_flc',col(e)).val(fla(colArgs(col(e))));
    vdTol('motor_rated_flc',col(e));
  }
  function showHdResults(show=false) {
    $('#results,#results~tr').toggle(show);
    $('p button').toggle(!show);
  }
  function colArgs(col) {
    const d=setData({},col);
    d['line'] = nm('line',col);
    cvtObj(d,'flow',CVT_FLOW,0,'m^3/s');
    cvtObj(d,['motor_rated_power','motor_field_power'],CVT_POWER,1,'kW');      
    cvtObj(d,'head',CVT_DIST,2,'m');
    return d;
  }
  function results() {
    $('th:gt(1)').each((i,e)=>{
      const col = $(`td:nth-child(${$(e).index()+1})`),
        a = colArgs(col), r = Bridge.results(a);
      cvtObj(r,[2,3,4,5,6,7,14],CVT_POWER,'kW',Units[1]);            
      col.filter('#results~tr:not(.th) td').each((i,e)=>{        
        $(e).html(`<div>
                    <span ${i==2 && r[4]>nm('motor_rated_power',col).val() ? 'style=background-color:#FECB00' : ''}>
                      ${r[2*i]>=0 ? rnd(r[2*i]) :''}
                    </span>
                    <span style='color:#5d9300'>${rnd(r[2*i+1])}</span></div>`);
      });
      vdTol('motor_rated_flc',col,fla(a),.5);
      vdTol('motor_field_voltage',col,nm('motor_rated_voltage',col).val(),.1);
    });
    showHdResults(true);
  }

  function gotoHead(e) {
    Flow = nm('flow',col(e)).val();
    SG = nm('specific_gravity',col(e)).val();
    HeadEl = nm('head',col(e));
    backload("headTool");
  }
  function edit(e) {
    Idx = $(e).parent().data('idx');
    backload('notes');
  }
  function backload(nm) {
    Grid = pg().contents().detach();
    load(nm);
    back = backToGrid;
  }
  function backToGrid() {
    pg().html(Grid);
    //$('#container').append($('#container script').remove());

    $('th:gt(1)>span').each(function(i,e) {
      $(e).text(colCond(e).name);
    });
    delete Grid;
    back = main;
  }

  function fldUnit(nm) {
    $(`td>div:not(:has(em)):contains(${nm})`).append(`<em>(${txt})</em>`);
  }  

  txt = Units[1];
  fldUnit('Power Rating');
  fldUnit('Motor Rated');
  fldUnit('Motor Shaft');
  fldUnit('Pump Shaft');
  fldUnit('Motor Power');
  txt = Units[2];
  fldUnit('Head');
  txt = Units[0];
  fldUnit('Flow');

  $.each(Cond,function(idx,d) {
    if (d.grid) {
          $('table tr').each(function (i,e) {
            const newEl = $(e).children().eq(1).clone();            
            $(e).append(newEl);
            newEl.find('input,select').attr('tabindex',newEl.index());
            newEl.data('idx',idx);
            if (i==0) {
              newEl.find('span').text(d.name);     
            } else {              
              setCtls(d,newEl);              
            }
          });
    }
  });         

  nmAll('#grid').change(function() {
    saveCol(this);
    showHdResults(false);
  });
</script>
