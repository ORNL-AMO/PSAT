<style scoped>
	.shade {
		background-color: lightgray;
	}
	#units select {
		vertical-align: middle;
	}
	#units label {
		padding-right: 1rem;
	}
	#units td:first-child {
		color: green;
		padding-right: 1rem;
	}
	#units td:last-child, #units th:last-child {
		display: none;
	}
	#units th:nth-child(n+2),#units td:nth-child(n+2) {
		padding-right: 1rem;
		padding-left: 1rem;
	}
	#units table {
		border-collapse: collapse;
	}
	#cond td>* {
		display: block;
	}
	#cond tr:first-child {
		display: none;
	}
	#cond td:nth-child(2):hover {
		background-color: lightgray;
		cursor: pointer;
	}
	p button {
		float:left;
	}
</style>
<div style='display: inline-block'>
	<button onclick='reset()'>RESET</button>
	<button onclick="imprt()">IMPORT</button>
	<button class=gt0 onclick="xprt()">EXPORT</button>
	<h1>Units</h1>
	<div id="units">
		<label><input type=radio name=unit_sys></input> Imperial</label>
		<label><input type=radio name=unit_sys></input> Metric</label>
		<label><input type=radio name=unit_sys></input> Custom</label>
		<p>
		<table>
			<tr>
				<th></th>
				<th>Imperial</th>
				<th>Metric</th>
				<th>Custom</th>
			</tr>
			<tr>
				<td>Flow</td>
				<td>gpm</td>
				<td>m^3/hr</td>
				<td>
					<select>
						<option>gpm</option>
						<option>MGD</option>
						<option>m^3/hr</option>
						<option>L/s</option>
					</select>
				</td>
			</tr>
			<tr>
				<td>Power</td>
				<td>hp</td>
				<td>kW</td>
				<td>
					<select>
						<option>hp</option>
						<option>kW</option>				
					</select>
				</td>
			</tr>
			<tr>
				<td>Distance</td>
				<td>ft</td>
				<td>m</td>
				<td>
					<select>
						<option>ft</option>
						<option>m</option>
					</select>
				</td>
			</tr>
			<tr>
				<td>Pressure</td>
				<td>psig</td>
				<td>kPa</td>
				<td>
					<select>
						<option>psig</option>
						<option>kPa</option>
					</select>
				</td>
			</tr>
		</table>
	</div>
	<h1>Conditions</h1>
	<table id=cond>
		<tr>
			<td><input type="checkbox" onclick="setGrid(this)"></td>
			<td onclick='edit(this)'></td>
			<td><button onclick='rm(this)'><i class="fa fa-times"></i></button></td>
			<td><button onclick='cp(this)'><i class="fa fa-plus"></i></button></td>
		</tr>
		<tr>
			<td><input class=gt0 type="checkbox" checked onclick='chkAll(this)'></input></td>
		</tr>
	</table>
	<p>
		<button class=prime onclick='nu()'>NEW</button>
		<button class=prime id=grid onclick='grid()'><i class="fa fa-table"></i></button>
		<button style='float:right' class=gt0 onclick='removeAll()'>REMOVE ALL</button>
	</p>
</div>
<script>
	function listIdx(e) {
		return parIdx(e.parentElement,-2);
	}
	function chkAll(e) {
		$(':checkbox').prop('checked',e.checked);
		$.each(Cond,function(i,d) {
			d.grid = e.checked;
		});
		saveCond();
		setGridBtn();
	}
	function setGrid(e) {
		Cond[listIdx(e)].grid = e.checked;
		saveCond();
		setGridBtn();		
	}
	function grid() {
		load('grid');		
	}
	function setGridBtn() {
		if ($('#cond :checkbox:gt(1):checked').length>0) {
			$('#grid').show();
		} else {
			$('#grid').hide();
		}
	}
	function rm(e) {
		Cond.splice(listIdx(e),1);
		saveCond();
		main();
	}
	function removeAll() {
		Cond = [];
		saveCond();
		main();
	}
	function cp(e) {
		let o=$.extend({},Cond[listIdx(e)]);
		o.name+=' (copy)';
		Cond.push(o);
		saveCond();
		main();
	}
	function edit(e) {
		Idx = parIdx(e,-2);
		load('notes');
	}
	function nu() {
		Idx = Cond.length;
		load('notes');
	}
	function reset() {
		loadData(true);
		main();
	}

	function cvtObj(d,nms,m,i,nu) {
		$.makeArray(nms).forEach((nm)=>{
			d[nm] = cvt(d[nm],m,i,nu);
		});
	}
    
	function chgUnits(nunits) {
		function cvtObjArr(...args) {
			cvtObj(...args,nunits[args.pop()]);
    	}
		$.each(Cond.concat([DefCond]),function(i,d) {
			cvtObjArr(d,'flow',CVT_FLOW,0);
			cvtObjArr(d,['motor_rated_power','motor_field_power'],CVT_POWER,1);
			cvtObjArr(d,'head',CVT_DIST,2);
		});
		saveProp('defCond',DefCond);
		cvtObjArr(HeadTool,['Ds','Dd','Zs','Ztnk_s','Zd'],CVT_DIST,2);		
		cvtObjArr(HeadTool,['Ps','Pg_s','Pd'],{kPa:0.145037738007},3);		
		saveHd();
		Units = nunits;
		saveProp('units',Units);
		saveCond();
	}
	function shade(n) {
		$('td').removeClass('shade');
		$(`#units td:nth-child(${n})`).addClass('shade');		
	}
	function showCus(lastCol) {
		lastCol.find('select').each(function(i,e) {
			$(e).val(Units[i]);
		});
		lastCol.show();		
	}

	function xprt() {		
		Dlg.showSaveDialog(DlgFilter,
			function (fn) {
				if (fn) {					
					const 
						hd=Object.keys(Cond[0]).sort(),
						lines=[JSON.stringify([0,Units,HeadTool]),hd.join('\t')];
					Cond.forEach(function(d,i) {
						lines.push(
							hd.map((nm,i)=> {
								return d[nm];
							}).join('\t')
						);
					});		
					require('fs').writeFile(fn,lines.join('\n'));				
				}
		}); 
	}
	function imprt() {
		Dlg.showOpenDialog(DlgFilter,
			function (fn) {
				if (fn ) {
					const 
						fs = require('fs'),
						lines=fs.readFileSync(fn[0],'utf8').split('\n'),
						hd=lines[1].split('\t');
					Cond=[];
					[,Units,HeadTool]=JSON.parse(lines[0]);					
					lines.slice(2).forEach((ln,row)=>{
						Cond.push({});
						ln.split('\t').forEach((v,i)=>{
							Cond[row][hd[i]]=v;
						});
					});
					saveCond();
					main();	
				}
			}
		); 
	}		
	function start() {
		const lastCol = $('#units th:last-child,#units td:last-child');
		const met = ['m^3/hr','kW','m','kPa'];
		let i;
		switch (Units.toString()) {
			case IMP.toString():
				i=0;
				break;
			case met.toString():
				i=1;
				break;
			default:
				i=2;
				showCus(lastCol);
		}
		$('#units :radio')[i].checked = true;
		shade(i+2);
				
		$('#units :radio').change(function() {			
			switch (parIdx(this)) {
				case 0:
					lastCol.hide();
					chgUnits(IMP);
					break;
				case 1:
					lastCol.hide();
					chgUnits(met);
					break;
				case 2:
					showCus(lastCol);
			}
			shade(parIdx(this,2));
		}); 
		$('#units select').change(function() {
			const nu=Units.slice();
			nu[$('#units select').index(this)]=$(this).val();
			chgUnits(nu);
		});
		$.each(Cond,function(i,d) {		
			const nu = $('#cond tr').first().clone();
			nu.children().eq(1).text(d.name);
			nu.find(':checkbox').prop('checked',d.grid);
			$('#cond').append(nu);		  

		});		
		if (Cond.length==0) {
			$('#cond').html('<em>None</em>');
			$('.gt0').hide();
		}		
		setGridBtn();
	}
	
	DlgFilter={filters: [{ name: 'Tab Separated Values', extensions: ['tsv'] }]};
	start();
</script>