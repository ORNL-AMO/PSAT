<style>
	#cond td>* {
		display: block;
	}
	#cond tr:first-child {
		display: none;
	}
	#cond td:nth-child(2):hover {
		background-color: #C3C8C8;
		cursor: pointer;
	}
	p button {
		float:left;
		margin-right:2px;
	}
</style>
<div style='display: inline-block'>
	<h1>Pump Conditions</h1>
	<ul style='font-style:italic'>
		<li>Click to edit description</li>
		<li>Select to edit input parameters or export</li>		
	</ul>
	<table id=cond>
		<tr>
			<td><input type="checkbox" onclick="setGrid(this)"></td>
			<td onclick='edit(this)'></td>
			<td><button onclick='rm(this)'><i class="fa fa-trash-o"></i></button></td>
			<td><button onclick='cp(this)'><i class="fa fa-plus"></i></button></td>
		</tr>
		<tr>
			<td><input class=gt0 type="checkbox" checked onclick='chkAll(this)'></input></td>
		</tr>
	</table>
	<p>
		<button class=prime onclick='nu()'>NEW</button>
		<span id=grid>
			<button class=prime onclick='grid()'>PARAMETERS</button>
			<button onclick='xprt()'>EXPORT</i></button>		
		</span>
		<button style='float:right' class=gt0 onclick='removeAll()'>REMOVE ALL</button>
	</p>
</div>
<script>
	function listIdx(e) {
		return parIdx(e.parentElement,-2);
	}
	function chkAll(e) {
		chk(':checkbox',e.checked);
		$.each(Conds,function(i,d) {
			d.grid = e.checked;
		});
		saveConds();
		setGridBtn();
	}
	function setGrid(e) {
		Conds[listIdx(e)].grid = e.checked;
		saveConds();
		setGridBtn();		
	}
	function grid() {
		go('grid');		
	}
	function setGridBtn() {
		if ($('#cond :checkbox:gt(1):checked').length>0) {
			$('#grid').show();
		} else {
			$('#grid').hide();
		}
	}
	function rm(e) {
		Conds.splice(listIdx(e),1);
		saveConds();
		loadPg();
	}
	function removeAll() {
		Conds = [];
		saveConds();
		loadPg();
	}
	function cp(e) {
		let o=$.extend({},Conds[listIdx(e)]);
		o.name+=' (copy)';
		Conds.push(o);
		saveConds();
		loadPg();
	}

	function edit(e) {
		Cond = Conds[parIdx(e,-2)];
		go('notes');
	}
	function nu() {
		Cond = loadProp('defCond');
		Conds.push(Cond);
		Cond.name = 'Condition ' + Conds.length;
		const dt = new Date();
    	dt.setMinutes(dt.getMinutes()-dt.getTimezoneOffset());
		Cond.date = dt.toJSON().slice(0,10);		
		saveConds();
		go('notes');
	}	

	function xprt() {		
		Dlg.showSaveDialog(dlgFil('csv'),
			function (fn) {
				if (fn) {					
					let hd, lines;
					Conds.forEach(function(c,i) {
						const r = crunch(cvtArg(c));						
						if (i==0) {
							hd = Object.keys(Conds[0]).sort().concat(Object.keys(r).sort());
							lines=[hd.join(',')];
						}
						if (c.grid) {
							$.each(r, (k,v) => {
								r[k] = JSON.stringify(v);
							});
							let o = $.extend({},r,c);
							lines.push(
								hd.map((nm,i)=> {
									return JSON.stringify(o[nm]);
								}).join(',')
							);
						}
					});		
					require('fs').writeFile(fn,lines.join('\n'));				
				}
		}); 
	}
	
	function start() {
		$.each(Conds,function(i,d) {		
			const nu = $('#cond tr').first().clone();
			nu.children().eq(1).text(d.name);
			chk(nu.find(':checkbox'),d.grid);
			$('#cond').append(nu);		  

		});		
		if (Conds.length==0) {
			$('#cond').html('<span style="font-style:italic">None</span>');
			$('.gt0').hide();
		}		
		setGridBtn();
	}
	start();
</script>